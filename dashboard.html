<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>USAFE Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
</head>

<body class="bg-gray-900 text-white min-h-screen">

  <!-- HEADER -->
  <div class="bg-gray-800 p-4 flex justify-between items-center border-b border-gray-700">
    <h1 class="text-2xl font-bold">USAFE Dashboard</h1>

    <div class="flex items-center gap-4">
      <span id="userDisplay" class="text-gray-300">Loading...</span>
      <img id="avatarImg" class="w-10 h-10 rounded border border-gray-600" src="">
      <button onclick="logout()" class="text-red-400 hover:text-red-300">Logout</button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="max-w-4xl mx-auto p-6">

    <h2 class="text-xl font-semibold mb-4">Welcome, Soldier</h2>

    <!-- RANK CARD -->
    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 mb-6">
      <p class="text-gray-300 mb-2">Rank:</p>
      <p id="rankDisplay" class="text-3xl font-bold text-blue-400">Loading...</p>
    </div>

    <!-- PROFILE SUMMARY -->
    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 mb-6">
      <h3 class="text-lg font-semibold mb-3">Your Profile</h3>

      <p><strong>Name:</strong> <span id="profileName" class="text-gray-300">Loading...</span></p>
      <p><strong>Username:</strong> <span id="profileUser" class="text-gray-300">Loading...</span></p>
      <p><strong>Branch:</strong> <span id="profileBranch" class="text-gray-300">Loading...</span></p>
      <p><strong>Rank:</strong> <span id="profileRank" class="text-gray-300">Loading...</span></p>
      <p><strong>Points:</strong> <span id="profilePoints" class="text-gray-300">0</span></p>
      <p><strong>Valor:</strong> <span id="profileValor" class="text-gray-300">0</span></p>

      <p id="profileStatus" class="text-gray-400 text-sm mt-3"></p>
    </div>

    <!-- MEDALS -->
    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 mb-6">
      <h3 class="text-lg font-semibold mb-3">Medals</h3>
      <div id="medalList"></div>
    </div>

    <!-- TRAININGS -->
    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 mb-6">
      <h3 class="text-lg font-semibold mb-3">Training Attendance</h3>
      <div id="trainingList"></div>
    </div>

    <!-- BUTTONS -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

      <button onclick="window.location.href='profile.html'"
        class="bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-semibold flex items-center justify-center gap-2">
        <i data-feather="user"></i> Profile
      </button>

      <button id="staffBtn"
        class="bg-yellow-600 hover:bg-yellow-700 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 hidden">
        <i data-feather="shield"></i> Staff Panel
      </button>

    </div>

  </div>

  <script>
const API = "https://usafe-staff-portal.onrender.com";

// Redirect if not logged in
const token = localStorage.getItem("usafe_token");
const robloxId = localStorage.getItem("usafe_roblox_id");
const username = localStorage.getItem("usafe_username");
const displayName = localStorage.getItem("usafe_display_name");

if (!token || !robloxId) {
  window.location.href = "login.html";
}

// Display user in header
document.getElementById("userDisplay").textContent = `${displayName} (@${username})`;

// Load avatar
async function loadAvatar() {
  try {
    const res = await fetch(
      `https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${robloxId}&size=150x150&format=Png&isCircular=false`
    );
    const data = await res.json();
    const url = data?.data?.[0]?.imageUrl;

    const avatarImg = document.getElementById("avatarImg");
    if (avatarImg) avatarImg.src = url || "";
  } catch (err) {
    console.warn("Avatar failed to load");
  }
}

// Load USAFE profile
async function loadProfile() {
  const status = document.getElementById("profileStatus");

  try {
    const res = await fetch(`${API}/api/users/${robloxId}`);
    const data = await res.json();

    if (!res.ok) {
      status.textContent = "Failed to load profile.";
      return;
    }

    // Fill UI
    document.getElementById("profileName").textContent = displayName;
    document.getElementById("profileUser").textContent = "@" + username;

    document.getElementById("profileRank").textContent = data.rank || "Unassigned";
    document.getElementById("rankDisplay").textContent = data.rank || "Unassigned";

    document.getElementById("profileBranch").textContent = data.branch || "None";
    document.getElementById("profilePoints").textContent = data.points;
    document.getElementById("profileValor").textContent = data.valor;

    // Show staff panel button if officer
    const officerRanks = ["2LT", "1LT", "CPT", "MAJ", "LTC", "COL", "GEN"];
    if (officerRanks.includes(data.rank)) {
      document.getElementById("staffBtn").classList.remove("hidden");
    }

    // Medals
    const medalList = document.getElementById("medalList");
    medalList.innerHTML = "";

    if (data.medals.length === 0) {
      medalList.innerHTML = `<p class="text-gray-400 text-sm">No medals awarded yet.</p>`;
    } else {
      data.medals.forEach(m => {
        const item = document.createElement("div");
        item.className = "p-2 bg-gray-800 rounded border border-gray-700 mb-2";
        item.innerHTML = `
          <p class="font-semibold">${m.medal_name}</p>
          <p class="text-xs text-gray-400">${m.date}</p>
          <p class="text-xs">${m.reason}</p>
        `;
        medalList.appendChild(item);
      });
    }

    // Trainings
    const trainingList = document.getElementById("trainingList");
    trainingList.innerHTML = "";

    if (data.trainings.length === 0) {
      trainingList.innerHTML = `<p class="text-gray-400 text-sm">No trainings attended.</p>`;
    } else {
      data.trainings.forEach(t => {
        const item = document.createElement("div");
        item.className = "p-2 bg-gray-800 rounded border border-gray-700 mb-2";
        item.innerHTML = `
          <p class="font-semibold">${t.type}</p>
          <p class="text-xs text-gray-400">${t.date}</p>
        `;
        trainingList.appendChild(item);
      });
    }

    status.textContent = "";

  } catch (err) {
    console.error(err);
    status.textContent = "Error loading profile.";
  }
}

// Logout
function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}

// Run on page load
loadAvatar();
loadProfile();
feather.replace();
  </script>

</body>
</html>
